<?xml version="1.0" encoding="UTF-8"?>

<!--
 * See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see http://www.gnu.org/licenses/
-->

<xwikidoc version="1.1">
  <web>PhenoTips</web>
  <name>MatchContact</name>
  <language/>
  <defaultLanguage/>
  <translation>0</translation>
  <creator>xwiki:XWiki.Admin</creator>
  <creationDate>1430385664000</creationDate>
  <parent>PhenoTips.SimilarCases</parent>
  <author>xwiki:XWiki.Admin</author>
  <contentAuthor>xwiki:XWiki.Admin</contentAuthor>
  <date>1430385664000</date>
  <contentUpdateDate>1430385664000</contentUpdateDate>
  <version>1.1</version>
  <title>MatchContact</title>
  <comment/>
  <minorEdit>false</minorEdit>
  <syntaxId>xwiki/2.1</syntaxId>
  <hidden>true</hidden>
  <content>{{velocity output="false"}}
#macro (_prepareConfig $options)
  #set ($email = $xwiki.getDocument($xcontext.user).getObject('XWiki.XWikiUsers').getProperty('email').value)
  #set ($groups = '')
  #set ($groupDocs = $xwiki.wrapDocs($xwiki.rightsmanager.getAllGroupsNamesForMember($xcontext.userReference)))
  #foreach ($gDoc in $groupDocs)
    #if ($gDoc.getObject('PhenoTips.PhenoTipsGroupClass'))
      #set ($g = "#if ($gDoc.plainTitle != '')${gDoc.plainTitle}#else${gDoc.name}#end")
      #if ($g != '')
        #set ($groups = "#if ($groups != '')${groups} | #end${g}")
      #end
    #end
  #end

  #set ($patientURL = $xwiki.getDocument($services.patients.get("$!{request.patient}").getDocument()).getExternalURL())
  ## Circumvent rights check to get matching patient's URL
  #set ($matchURL = $patientURL.replace($request.patient, $request.matchId))
  #set ($config = {
      'name'     : "#if($options.name)$xwiki.getUserName($xcontext.user, false)#end",
      'email'    : "#if($options.email)$!{email}#end",
      'groups'   : "#if($options.groups)${groups}#end",

      'subject'  : "[$!{platformName}] $!{options.subject}",
      'message'  : "$!{options.message}",

      'patientURL': "$!{patientURL}",
      'matchURL'  : "$!{matchURL}"
  })
#end

#macro (_generateMessage $options)
  #_prepareConfig($options)
  #set ($emailObj = $doc.getObject('XWiki.Mail'))
  &lt;dl&gt;
    &lt;dt&gt;&lt;label for="anon-msg-subject"&gt;$services.localization.render('phenotips.matchContact.subject.label')&lt;/label&gt;&lt;/dt&gt;
    &lt;dd&gt;&lt;input type="text" name="subject" class="subject" value="$services.localization.render('phenotips.matchContact.subject.input', [${request.matchId}])"&gt;&lt;/input&gt;&lt;/dd&gt;
    &lt;dt&gt;&lt;label for="anon-msg-body"&gt;$services.localization.render('phenotips.matchContact.message.label')&lt;/label&gt;&lt;/dt&gt;
    &lt;dd class="message"&gt;
      &lt;textarea name="message"&gt;
        #evaluate($emailObj.getProperty('text').value)
      &lt;/textarea&gt;
    &lt;/dd&gt;
  &lt;/dl&gt;
#end

#macro (_generateHidden $name $value)&lt;input type="hidden" name="$name" value="$value" /&gt;#end
{{/velocity}}

{{velocity}}
#if ($request.patient &amp;&amp; $request.token)
  #set ($patient = $services.patients.get("$!{request.patient}"))
  #set ($discard = $xwiki.ssx.use($doc.fullName))
  #set ($platformName = 'PhenomeCentral')## TODO: get this from a configuration
  #if ($request.send)
    #set ($options = {
      'subject'  : "$!{request.subject}",
      'message'  : "$!{request.message}"
    })
    #set ($result = $services.anonymousCommunication.sendInitialMail($request.token, $options))
    #if ($result != 0)
      $response.setStatus($result)
    #end
  #else
    #set ($defaults = {
      'name'      : true,
      'email'     : true,
      'groups'    : true
      })
    #if ($!{request.contact} != '')
      #set ($recipientUserName = $xwiki.getUserName($!{request.contact}, false))
      #set ($recipientUserDoc = $xwiki.getDocument("XWiki.$!{recipientUserName}"))
      #set ($recipientUserObj = $recipientUserDoc.getObject("XWiki.XWikiUsers"))
      #set ($recipientFirstName = $recipientUserObj.getProperty("first_name").getValue())
      #set ($recipientLastName = $recipientUserObj.getProperty("last_name").getValue())
      #set ($recipientAffiliation  = $recipientUserObj.getProperty("company").getValue())
      #set ($toText = "")
      #if ("$!{recipientFirstName}" != "")
        #set ($toText = $!{recipientFirstName})
        #if ("$!{recipientLastName}" != '')
          #set ($toText = $toText + " $!{recipientLastName}")
        #end
      #else
        #set ($toText = $toText + $recipientUserName)
      #end
      #if ("$!{recipientAffiliation}" != '' &amp;&amp; "$!{toText}" != '')
        #set ($toText = $toText + " at $!{recipientAffiliation}")
      #end
    #end
    #set ($email = $xwiki.getDocument($xcontext.user).getObject('XWiki.XWikiUsers').getProperty('email').value)
    {{html clean=false}}
    &lt;form class="xform" action="$doc.getURL('get')" method="post"&gt;
      &lt;div&gt;
        &lt;h2&gt;Send a message&lt;/h2&gt;
        &lt;dt&gt;&lt;label&gt;To&lt;/label&gt;&lt;/dt&gt;
        &lt;dd&gt;&lt;input type="text" value="$!{toText}" disabled&gt;&lt;/input&gt;
        &lt;dt&gt;&lt;label&gt;From&lt;/label&gt;&lt;/dt&gt;
        &lt;dd&gt;&lt;input type="text" value="$xwiki.getUserName($xcontext.user, false) &amp;lt;$email&amp;gt;" disabled&gt;&lt;/input&gt;&lt;/dd&gt;
        &lt;div id="contact-message-preview"&gt;
          #_generateMessage($defaults)
        &lt;/div&gt;
        &lt;input type="hidden" name="patient" value="$!{request.patient}" /&gt;
        &lt;input type="hidden" name="token" value="$!{request.token}" /&gt;
        &lt;div class="buttons"&gt;
          &lt;span class="buttonwrapper"&gt;&lt;input type="submit" name="send" value="Send" class="button" /&gt;&lt;/span&gt;
          &lt;span class="buttonwrapper"&gt;&lt;input type="button" name="cancel" value="cancel" class="button secondary" /&gt;&lt;/span&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/form&gt;
    {{/html}}
  #end## Generate form
#end## Patient and token exist
{{/velocity}}</content>
  <object>
    <name>PhenoTips.MatchContact</name>
    <number>0</number>
    <className>XWiki.Mail</className>
    <guid>e6be4785-605c-421d-a227-52c47ed7f63a</guid>
    <class>
      <name>XWiki.Mail</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <html>
        <disabled>0</disabled>
        <name>html</name>
        <number>4</number>
        <prettyName>HTML</prettyName>
        <rows>15</rows>
        <size>80</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </html>
      <language>
        <disabled>0</disabled>
        <name>language</name>
        <number>2</number>
        <prettyName>Language</prettyName>
        <size>5</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </language>
      <subject>
        <disabled>0</disabled>
        <name>subject</name>
        <number>1</number>
        <prettyName>Subject</prettyName>
        <size>40</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </subject>
      <text>
        <disabled>0</disabled>
        <name>text</name>
        <number>3</number>
        <prettyName>Text</prettyName>
        <rows>15</rows>
        <size>80</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </text>
    </class>
    <property>
      <html/>
    </property>
    <property>
      <language/>
    </property>
    <property>
      <subject>$config.subject</subject>
    </property>
    <property>
      <text>## ===== Look up disorders =====
#set($sortedDisorders = [])
#set($hasDisorders = $patient.disorders &amp;&amp; $patient.disorders.size() &gt; 0)
#if ($hasDisorders)
#set($sortedDisorders = $sorttool.sort($patient.disorders, 'name'))
#end
##
## ===== Look up features =====
#set($sortedFeatures = [])
#set($hasFeatures = $patient.features &amp;&amp; $patient.features.size() &gt; 0)
#if ($hasFeatures)
#foreach ($f in $patient.features)
#set($discard = $sortedFeatures.add({'name' : $f.name, 'feature' : $f}))
#end
#set($sortedFeatures = $sorttool.sort($sortedFeatures, 'name'))
#end
##
## ===== Look up genes =====
#set($sortedGenes = [])
#foreach($gene in $xwiki.getDocument($patient.getDocument()).getObjects('PhenoTips.GeneClass'))
#set ($symbol = $gene.getValue('gene'))
#set ($term = $services.vocabularies.hgnc.getTerm("${symbol}"))
#if ($term)
  #set ($symbol = $term.symbol)
#end
#set ($status = $gene.getValue('status'))
#if ($status != 'rejected')
#set ($discard = $sortedGenes.add({'symbol' : $symbol, 'status' : $status}))
#end
#end
#set($sortedGenes = $sorttool.sort($sortedGenes, ['status:desc', 'symbol:asc']))
#set($hasGenes = $sortedGenes.size() &gt; 0)
##
## ===== Begin email template =====
Hello#if("$!{firstName}" != '') $firstName#end,

${platformName} has identified similarities between one of my patients and your patient: $!{config.matchURL}

My patient##
#if($hasDisorders)
 is diagnosed with:
#foreach ($d in $sortedDisorders)
* $d.name
#end
#if ($hasFeatures)

My patient##
#end
#else
 is undiagnosed##
#if ($hasFeatures)
 and##
#else
.
#end
#end
#if ($hasFeatures)
 presents with the following phenotypic features:
#foreach ($f in $sortedFeatures)
* #if (!$f.feature.isPresent())NO #end$f.name
#if ($f.feature.metadata)
#foreach ($m in $f.feature.metadata.keySet())
  - $f.feature.metadata.get($m).name
#end
#end
#end
#end
#if ($hasGenes)

I have identified the following genes as relevant:
#foreach ($g in $sortedGenes)
* $g.symbol ($g.status)
#end
#end

Please let me know if you are interested in my case: $!{config.patientURL}

#if ("$!{config.name}$!{config.email}" != '')
Regards,
$!{config.name}
$!{config.email}
$!{config.groups}
#end</text>
    </property>
  </object>
  <object>
    <name>PhenoTips.MatchContact</name>
    <number>0</number>
    <className>XWiki.StyleSheetExtension</className>
    <guid>03e1a4b5-fa39-4bb2-a7f0-bef1cc1d3ee0</guid>
    <class>
      <name>XWiki.StyleSheetExtension</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <cache>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>cache</name>
        <number>5</number>
        <prettyName>Caching policy</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators>|, </separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>long|short|default|forbid</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </cache>
      <code>
        <disabled>0</disabled>
        <name>code</name>
        <number>2</number>
        <prettyName>Code</prettyName>
        <rows>20</rows>
        <size>50</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </code>
      <contentType>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>contentType</name>
        <number>6</number>
        <prettyName>Content Type</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators>|, </separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>CSS|LESS</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </contentType>
      <name>
        <disabled>0</disabled>
        <name>name</name>
        <number>1</number>
        <prettyName>Name</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
      <parse>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>yesno</displayType>
        <name>parse</name>
        <number>4</number>
        <prettyName>Parse content</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </parse>
      <use>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>use</name>
        <number>3</number>
        <prettyName>Use this extension</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators> ,|</separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>currentPage=Always on this page|onDemand=On demand|always=Always on this wiki</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </use>
    </class>
    <property>
      <cache>long</cache>
    </property>
    <property>
      <code>#template("colorThemeInit.vm")

.anonymous-contact {
  overflow: hidden;
}
.anonymous-contact .contact-form-panel {
  width: 48% !important;
  margin: 0 1%;
  float: left;
}
.anonymous-contact .contact-form-panel h2:before {
  background-color: $theme.textColor;
  border-radius: 50%;
  color: $theme.pageContentBackgroundColor;
  height: 1.2em;
  line-height: 1.2em;
  margin-right: .3em;
  text-align: center;
  text-shadow: none;
  display: inline-block;
  width: 1.2em;
}
.anonymous-contact .configure h2:before {
  content: "1";
}
.anonymous-contact .message-preview h2:before {
  content: "2";
}

.anonymous-contact .message-preview .message, .anonymous-contact .message-preview .subject {
  background: $theme.highlightColor none no-repeat scroll left 0.9em;
  border: 1px solid $theme.pageContentBackgroundColor;
  border-radius: 4px 4px 4px 4px;
  box-shadow: 1px 1px 5px rgba(0, 0, 0, 0.2) inset;
  padding: 0 1em 0 28px;
}
.anonymous-contact .message-preview .subject {
  padding: .3em;
}
.anonymous-contact .message-preview .message {
  background-image: url("$xwiki.getSkinFile('icons/xwiki/lquo.gif')");
}
.anonymous-contact .message-preview .message #user-message {
  background: $theme.backgroundSecondaryColor;
  padding: .3em;
}
.anonymous-contact .message-preview .message p {
  margin: 1em 0;
}
.undisclosed {
  font-size: .9;
  font-style: italic;
  opacity: .5;
}

.undisclosed:before {
  content : "&lt;"
}
.undisclosed:after {
  content : "&gt;"
}
.anonymous-contact .buttons {
  clear: both;
  text-align: right;
}

.anonymous-contact textarea[name="message"]{
    height: 380px;
    resize: none;
    overflow-y: scroll;
    font-size: 100%;
}
.anonymous-contact h2 {
    margin-top: 0;
}
.anonymous-contact .header {
    color: $theme.textColor;
    font-size: .85em;
    font-weight: 700;
    margin-bottom: .3em;
    text-transform: uppercase;
}</code>
    </property>
    <property>
      <contentType>CSS</contentType>
    </property>
    <property>
      <name/>
    </property>
    <property>
      <parse>1</parse>
    </property>
    <property>
      <use>always</use>
    </property>
  </object>
  <object>
    <name>PhenoTips.MatchContact</name>
    <number>0</number>
    <className>XWiki.XWikiRights</className>
    <guid>78631e3f-e026-49da-87df-a14d67f1df87</guid>
    <class>
      <name>XWiki.XWikiRights</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <allow>
        <defaultValue>1</defaultValue>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>allow</displayType>
        <name>allow</name>
        <number>4</number>
        <prettyName>Allow/Deny</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </allow>
      <groups>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>input</displayType>
        <multiSelect>1</multiSelect>
        <name>groups</name>
        <number>1</number>
        <picker>1</picker>
        <prettyName>Groups</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <size>5</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.GroupsClass</classType>
      </groups>
      <levels>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>1</multiSelect>
        <name>levels</name>
        <number>2</number>
        <prettyName>Levels</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <size>3</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.LevelsClass</classType>
      </levels>
      <users>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>input</displayType>
        <multiSelect>1</multiSelect>
        <name>users</name>
        <number>3</number>
        <picker>1</picker>
        <prettyName>Users</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <size>5</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.UsersClass</classType>
      </users>
    </class>
    <property>
      <allow>1</allow>
    </property>
    <property>
      <groups>XWiki.XWikiAllGroup</groups>
    </property>
    <property>
      <levels>view</levels>
    </property>
    <property>
      <users>XWiki.XWikiGuest</users>
    </property>
  </object>
</xwikidoc>
